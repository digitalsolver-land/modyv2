
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moody - Analyse</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background-color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .nav-links {
            display: flex;
        }
        
        .nav-link {
            padding: 8px 16px;
            margin-left: 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav-link:hover {
            background-color: #f0f0f0;
        }
        
        .nav-link.active {
            border-bottom: 2px solid #4CAF50;
            color: #4CAF50;
        }
        
        .logout-btn {
            padding: 8px 16px;
            margin-left: 20px;
            border: 1px solid #e74c3c;
            background: none;
            color: #e74c3c;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background-color: #e74c3c;
            color: white;
        }
        
        .main-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-top: 0;
            text-align: center;
        }
        
        .controls-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .date-range-filter {
            display: flex;
            align-items: center;
        }
        
        .date-range-filter select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .pdf-export-btn {
            padding: 10px 20px;
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .pdf-export-btn:hover {
            background-color: #ff5252;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        @media (min-width: 768px) {
            .charts-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .chart-card {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.05);
        }
        
        .chart-card.full-width {
            grid-column: 1 / -1;
        }
        
        .chart-title {
            margin-top: 0;
            margin-bottom: 20px;
            color: #4CAF50;
            text-align: center;
            font-size: 1.2rem;
        }
        
        .chart-container {
            width: 100%;
            height: 400px;
            position: relative;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            color: #666;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            display: inline-block;
        }
        
        canvas {
            max-width: 100%;
        }
        
        .no-data-message {
            text-align: center;
            padding: 20px;
            color: #777;
            font-style: italic;
        }
        
        .menstrual-cycle-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #fff0f5;
            border-radius: 8px;
            border-left: 4px solid #FF69B4;
        }
        
        .menstrual-cycle-title {
            color: #FF69B4;
            margin-top: 0;
        }
        
        .date-input-container {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }
        
        .date-input-container label {
            margin-right: 10px;
            white-space: nowrap;
        }
        
        .update-date-btn {
            padding: 8px 16px;
            background-color: #FF69B4;
            color: white;
            border: none;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
        }
        
        .update-date-btn:hover {
            background-color: #FF5BA7;
        }
        
        .back-btn {
            display: block;
            width: fit-content;
            margin: 30px auto 0;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .back-btn:hover {
            background-color: #45a049;
        }
        
        .success-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-out 2.7s;
            z-index: 1000;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .loading-message {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">MOODY</div>
            <div class="nav-links">
                <button class="nav-link" onclick="window.location.href='/dashboard'">Tableau de bord</button>
                <button class="nav-link active">Analyse</button>
                <button class="nav-link" onclick="window.location.href='/suggestions'">Suggestions</button>
                <button class="nav-link" onclick="window.location.href='/profile'">Profil</button>
            </div>
            <button class="logout-btn" onclick="logout()">D√©connexion</button>
        </div>
        
        <div class="main-content">
            <h1>Analyse de votre humeur</h1>
            
            <div class="controls-section">
                <div class="date-range-filter">
                    <label for="date-range">P√©riode d'analyse:</label>
                    <select id="date-range" onchange="updateCharts()">
                        <option value="7">7 derniers jours</option>
                        <option value="30" selected>30 derniers jours</option>
                        <option value="90">3 derniers mois</option>
                        <option value="180">6 derniers mois</option>
                    </select>
                </div>
                <button class="pdf-export-btn" onclick="exportToPDF()">T√©l√©charger PDF</button>
            </div>
            
            <div class="charts-container" id="charts-container">
                <!-- Graphique d'humeur dans le temps -->
                <div class="chart-card full-width">
                    <h3 class="chart-title">√âvolution de votre humeur</h3>
                    <div class="chart-container">
                        <canvas id="mood-timeline-chart"></canvas>
                        <div id="loading-timeline" class="loading-message">Chargement du graphique...</div>
                    </div>
                </div>
                
                <!-- Graphique de distribution des √©mojis -->
                <div class="chart-card">
                    <h3 class="chart-title">Distribution des √©mojis</h3>
                    <div class="chart-container">
                        <canvas id="emoji-distribution-chart"></canvas>
                        <div id="loading-distribution" class="loading-message">Chargement...</div>
                    </div>
                </div>
                
                <!-- Graphique des r√©ponses aux questions -->
                <div class="chart-card">
                    <h3 class="chart-title">Moyennes des r√©ponses</h3>
                    <div class="chart-container">
                        <canvas id="questions-avg-chart"></canvas>
                        <div id="loading-questions" class="loading-message">Chargement...</div>
                    </div>
                </div>
                
                <!-- Statistiques g√©n√©rales -->
                <div class="chart-card full-width">
                    <h3 class="chart-title">Statistiques g√©n√©rales</h3>
                    <div class="chart-container" id="general-stats">
                        <div id="loading-stats" class="loading-message">Chargement des statistiques...</div>
                    </div>
                </div>
            </div>
            
            <!-- Section cycle menstruel (pour les utilisatrices) -->
            <div class="menstrual-cycle-section" id="menstrual-section" style="display: none;">
                <h3 class="menstrual-cycle-title">Suivi du cycle menstruel</h3>
                <p>Suivez les variations de votre humeur en fonction de votre cycle menstruel pour mieux comprendre vos √©motions.</p>
                
                <div class="date-input-container">
                    <label for="last-period-date">Derni√®res r√®gles:</label>
                    <input type="date" id="last-period-date">
                    <button class="update-date-btn" onclick="updateMenstrualDate()">Mettre √† jour</button>
                </div>
                
                <div class="chart-container">
                    <canvas id="cycle-correlation-chart"></canvas>
                </div>
            </div>
            
            <a href="/dashboard" class="back-btn">Retour au tableau de bord</a>
        </div>
    </div>
    
    <script>
        // Variables globales
        let moodEntries = [];
        let userGender = '';
        let lastMenstrualDate = '';
        let charts = {};
        
        // Fonction pour r√©cup√©rer les donn√©es
        async function fetchMoodData() {
            try {
                const days = document.getElementById('date-range').value;
                const response = await fetch(`/api/mood_history?days=${days}`);
                const data = await response.json();
                
                // Masquer les messages de chargement
                document.querySelectorAll('.loading-message').forEach(el => el.style.display = 'none');
                
                if (data.success) {
                    moodEntries = data.entries || [];
                    userGender = data.user_gender || '';
                    lastMenstrualDate = data.last_menstrual_date || '';
                    
                    document.getElementById('menstrual-section').style.display = 
                        userGender === 'F' ? 'block' : 'none';
                    
                    if (userGender === 'F' && lastMenstrualDate) {
                        document.getElementById('last-period-date').value = lastMenstrualDate;
                    }
                    
                    renderCharts();
                    renderGeneralStats();
                } else {
                    showNoDataMessage();
                }
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration des donn√©es:', error);
                showNoDataMessage();
            }
        }
        
        function showNoDataMessage() {
            const containers = document.querySelectorAll('.chart-container');
            containers.forEach(container => {
                container.innerHTML = '<div class="no-data-message">Aucune donn√©e disponible. Commencez √† enregistrer votre humeur pour voir appara√Ætre des analyses.</div>';
            });
        }
        
        function renderCharts() {
            if (moodEntries.length === 0) {
                showNoDataMessage();
                return;
            }
            
            // D√©truire les graphiques existants
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};
            
            renderTimelineChart();
            renderDistributionChart();
            renderQuestionsChart();
            
            if (userGender === 'F' && lastMenstrualDate) {
                renderCycleCorrelationChart();
            }
        }
        
        function renderTimelineChart() {
            const ctx = document.getElementById('mood-timeline-chart').getContext('2d');
            
            const emojiValues = {
                'very_happy': 5,
                'happy': 4,
                'neutral': 3,
                'sad': 2,
                'very_sad': 1,
                'angry': 2,
                'tired': 2.5,
                'anxious': 2
            };
            
            const sortedEntries = [...moodEntries].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const labels = sortedEntries.map(entry => {
                const date = new Date(entry.date);
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${day}/${month} ${hours}:${minutes}`;
            });
            
            const dataPoints = sortedEntries.map(entry => emojiValues[entry.emoji] || 3);
            
            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Niveau d\'humeur',
                        data: dataPoints,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.2,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#4CAF50',
                        pointBorderColor: 'white',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0.5,
                            max: 5.5,
                            ticks: {
                                callback: function(value) {
                                    const labels = {
                                        1: 'Tr√®s Bas',
                                        2: 'Bas',
                                        3: 'Neutre',
                                        4: 'Bon',
                                        5: 'Excellent'
                                    };
                                    return labels[value] || '';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function renderDistributionChart() {
            const ctx = document.getElementById('emoji-distribution-chart').getContext('2d');
            
            const emojiCounts = {};
            moodEntries.forEach(entry => {
                emojiCounts[entry.emoji] = (emojiCounts[entry.emoji] || 0) + 1;
            });
            
            const emojiLabels = {
                'very_happy': 'Tr√®s heureux(se)',
                'happy': 'Heureux(se)',
                'neutral': 'Neutre',
                'sad': 'Triste',
                'very_sad': 'Tr√®s triste',
                'angry': 'En col√®re',
                'tired': 'Fatigu√©(e)',
                'anxious': 'Anxieux(se)'
            };
            
            const labels = Object.keys(emojiCounts).map(emoji => emojiLabels[emoji] || emoji);
            const data = Object.values(emojiCounts);
            
            const backgroundColors = Object.keys(emojiCounts).map(emoji => {
                const colorMap = {
                    'very_happy': 'rgba(76, 175, 80, 0.8)',
                    'happy': 'rgba(139, 195, 74, 0.8)',
                    'neutral': 'rgba(255, 193, 7, 0.8)',
                    'sad': 'rgba(255, 152, 0, 0.8)',
                    'very_sad': 'rgba(244, 67, 54, 0.8)',
                    'angry': 'rgba(233, 30, 99, 0.8)',
                    'tired': 'rgba(156, 39, 176, 0.8)',
                    'anxious': 'rgba(103, 58, 183, 0.8)'
                };
                return colorMap[emoji] || 'rgba(33, 150, 243, 0.8)';
            });
            
            charts.distribution = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: 'white',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function renderQuestionsChart() {
            const ctx = document.getElementById('questions-avg-chart').getContext('2d');
            
            let q1Total = 0, q2Total = 0, q3Total = 0;
            moodEntries.forEach(entry => {
                q1Total += entry.question1 || 0;
                q2Total += entry.question2 || 0;
                q3Total += entry.question3 || 0;
            });
            
            const count = moodEntries.length;
            const q1Avg = count > 0 ? q1Total / count : 0;
            const q2Avg = count > 0 ? q2Total / count : 0;
            const q3Avg = count > 0 ? q3Total / count : 0;
            
            charts.questions = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: [
                        'Niveau d\'√©nergie',
                        'Niveau de stress',
                        'Satisfaction'
                    ],
                    datasets: [{
                        label: 'Moyennes',
                        data: [q1Avg, q2Avg, q3Avg],
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        borderColor: '#4CAF50',
                        borderWidth: 2,
                        pointBackgroundColor: '#4CAF50'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            suggestedMin: 0,
                            suggestedMax: 3
                        }
                    }
                }
            });
        }
        
        function renderCycleCorrelationChart() {
            if (!lastMenstrualDate || userGender !== 'F') return;
            
            const ctx = document.getElementById('cycle-correlation-chart').getContext('2d');
            
            const emojiValues = {
                'very_happy': 5,
                'happy': 4,
                'neutral': 3,
                'sad': 2,
                'very_sad': 1,
                'angry': 2,
                'tired': 2.5,
                'anxious': 2
            };
            
            const cycleData = moodEntries.map(entry => {
                const entryDate = new Date(entry.date);
                const menstrualDate = new Date(lastMenstrualDate);
                const daysDiff = Math.floor((entryDate - menstrualDate) / (24 * 60 * 60 * 1000));
                return {
                    day: daysDiff >= 0 ? daysDiff % 28 : 28 + daysDiff % 28,
                    moodValue: emojiValues[entry.emoji] || 3
                };
            });
            
            const cycleDays = Array(28).fill().map((_, i) => i + 1);
            const moodByDay = cycleDays.map(day => {
                const dayEntries = cycleData.filter(entry => entry.day === day - 1);
                if (dayEntries.length === 0) return null;
                return dayEntries.reduce((sum, entry) => sum + entry.moodValue, 0) / dayEntries.length;
            });
            
            charts.cycle = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: cycleDays.map(day => `Jour ${day}`),
                    datasets: [{
                        label: 'Humeur moyenne',
                        data: moodByDay,
                        borderColor: '#FF69B4',
                        backgroundColor: 'rgba(255, 105, 180, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 1,
                            max: 5,
                            ticks: {
                                callback: function(value) {
                                    const labels = {
                                        1: 'Tr√®s Bas',
                                        2: 'Bas',
                                        3: 'Neutre',
                                        4: 'Bon',
                                        5: 'Excellent'
                                    };
                                    return labels[value] || '';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderGeneralStats() {
            const container = document.getElementById('general-stats');
            
            if (moodEntries.length === 0) {
                container.innerHTML = '<div class="no-data-message">Aucune donn√©e disponible pour g√©n√©rer des statistiques.</div>';
                return;
            }
            
            const emojiValues = {
                'very_happy': 5,
                'happy': 4,
                'neutral': 3,
                'sad': 2,
                'very_sad': 1,
                'angry': 2,
                'tired': 2.5,
                'anxious': 2
            };
            
            const moodValues = moodEntries.map(entry => emojiValues[entry.emoji] || 3);
            const avgMood = moodValues.reduce((sum, value) => sum + value, 0) / moodValues.length;
            
            const emojiCounts = {};
            moodEntries.forEach(entry => {
                emojiCounts[entry.emoji] = (emojiCounts[entry.emoji] || 0) + 1;
            });
            
            let mostFrequentEmoji = '';
            let maxCount = 0;
            Object.entries(emojiCounts).forEach(([emoji, count]) => {
                if (count > maxCount) {
                    mostFrequentEmoji = emoji;
                    maxCount = count;
                }
            });
            
            const emojiLabels = {
                'very_happy': 'Tr√®s heureux(se)',
                'happy': 'Heureux(se)',
                'neutral': 'Neutre',
                'sad': 'Triste',
                'very_sad': 'Tr√®s triste',
                'angry': 'En col√®re',
                'tired': 'Fatigu√©(e)',
                'anxious': 'Anxieux(se)'
            };
            
            function getMoodLabel(value) {
                if (value >= 4.5) return 'Excellente';
                if (value >= 3.5) return 'Bonne';
                if (value >= 2.5) return 'Neutre';
                if (value >= 1.5) return 'Basse';
                return 'Tr√®s basse';
            }
            
            function formatDate(dateStr) {
                if (!dateStr) return 'N/A';
                const date = new Date(dateStr);
                return date.toLocaleDateString('fr-FR');
            }
            
            container.innerHTML = `
                <div style="padding: 20px; line-height: 1.8; font-size: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <strong>üìä Nombre d'entr√©es:</strong><br>
                            <span style="font-size: 24px; color: #4CAF50;">${moodEntries.length}</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <strong>üéØ Humeur moyenne:</strong><br>
                            <span style="font-size: 20px; color: #2196F3;">${getMoodLabel(avgMood)}</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <strong>üòä Humeur dominante:</strong><br>
                            <span style="font-size: 18px; color: #FF9800;">${emojiLabels[mostFrequentEmoji] || 'N/A'}</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <strong>üìÖ P√©riode analys√©e:</strong><br>
                            <span style="font-size: 16px;">Du ${formatDate(moodEntries[0]?.date)} au ${formatDate(moodEntries[moodEntries.length-1]?.date)}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function updateMenstrualDate() {
            const dateInput = document.getElementById('last-period-date');
            const newDate = dateInput.value;
            
            if (!newDate) {
                alert('Veuillez s√©lectionner une date valide.');
                return;
            }
            
            try {
                const response = await fetch('/api/update_menstrual_date', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ date: newDate })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    lastMenstrualDate = newDate;
                    showNotification('Date mise √† jour avec succ√®s!');
                    renderCycleCorrelationChart();
                } else {
                    alert('Erreur lors de la mise √† jour de la date: ' + (data.message || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors de la mise √† jour de la date.');
            }
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'success-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
        
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Configuration
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            const contentWidth = pageWidth - (margin * 2);
            
            // Titre principal
            pdf.setFontSize(22);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(76, 175, 80);
            pdf.text('Analyse de votre humeur - MOODY', margin, margin + 12);
            
            // Date de g√©n√©ration
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(0, 0, 0);
            const today = new Date().toLocaleDateString('fr-FR');
            pdf.text(`Rapport g√©n√©r√© le ${today}`, margin, margin + 25);
            
            // P√©riode analys√©e
            const period = document.getElementById('date-range').selectedOptions[0].text;
            pdf.text(`P√©riode: ${period}`, margin, margin + 35);
            
            let currentY = margin + 55;
            
            // Statistiques g√©n√©rales
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(76, 175, 80);
            pdf.text('üìä Statistiques g√©n√©rales', margin, currentY);
            currentY += 12;
            
            if (moodEntries.length > 0) {
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(0, 0, 0);
                
                const emojiValues = {
                    'very_happy': 5, 'happy': 4, 'neutral': 3, 'sad': 2, 'very_sad': 1,
                    'angry': 2, 'tired': 2.5, 'anxious': 2
                };
                
                const moodValues = moodEntries.map(entry => emojiValues[entry.emoji] || 3);
                const avgMood = moodValues.reduce((sum, value) => sum + value, 0) / moodValues.length;
                
                function getMoodLabel(value) {
                    if (value >= 4.5) return 'Excellente';
                    if (value >= 3.5) return 'Bonne';
                    if (value >= 2.5) return 'Neutre';
                    if (value >= 1.5) return 'Basse';
                    return 'Tr√®s basse';
                }
                
                const stats = [
                    `‚Ä¢ Nombre d'entr√©es: ${moodEntries.length}`,
                    `‚Ä¢ Humeur moyenne: ${getMoodLabel(avgMood)}`,
                    `‚Ä¢ Premi√®re entr√©e: ${new Date(moodEntries[0]?.date).toLocaleDateString('fr-FR')}`,
                    `‚Ä¢ Derni√®re entr√©e: ${new Date(moodEntries[moodEntries.length-1]?.date).toLocaleDateString('fr-FR')}`
                ];
                
                stats.forEach(stat => {
                    pdf.text(stat, margin + 3, currentY);
                    currentY += 7;
                });
                
                currentY += 10;
                
                // Distribution des √©mojis
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(76, 175, 80);
                pdf.text('üòä Distribution des √©motions', margin, currentY);
                currentY += 12;
                
                const emojiCounts = {};
                moodEntries.forEach(entry => {
                    emojiCounts[entry.emoji] = (emojiCounts[entry.emoji] || 0) + 1;
                });
                
                const emojiLabels = {
                    'very_happy': 'Tr√®s heureux(se)',
                    'happy': 'Heureux(se)',
                    'neutral': 'Neutre',
                    'sad': 'Triste',
                    'very_sad': 'Tr√®s triste',
                    'angry': 'En col√®re',
                    'tired': 'Fatigu√©(e)',
                    'anxious': 'Anxieux(se)'
                };
                
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(0, 0, 0);
                
                Object.entries(emojiCounts).forEach(([emoji, count]) => {
                    const percentage = Math.round((count / moodEntries.length) * 100);
                    pdf.text(`‚Ä¢ ${emojiLabels[emoji] || emoji}: ${count} fois (${percentage}%)`, margin + 3, currentY);
                    currentY += 7;
                });
                
                currentY += 10;
                
                // Moyennes des questions
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(76, 175, 80);
                pdf.text('üìà Moyennes des √©valuations', margin, currentY);
                currentY += 12;
                
                let q1Total = 0, q2Total = 0, q3Total = 0;
                moodEntries.forEach(entry => {
                    q1Total += entry.question1 || 0;
                    q2Total += entry.question2 || 0;
                    q3Total += entry.question3 || 0;
                });
                
                const count = moodEntries.length;
                const q1Avg = count > 0 ? (q1Total / count).toFixed(1) : 0;
                const q2Avg = count > 0 ? (q2Total / count).toFixed(1) : 0;
                const q3Avg = count > 0 ? (q3Total / count).toFixed(1) : 0;
                
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(0, 0, 0);
                
                const questionStats = [
                    `‚Ä¢ Niveau d'√©nergie: ${q1Avg}/3`,
                    `‚Ä¢ Niveau de stress: ${q2Avg}/3`,
                    `‚Ä¢ Satisfaction de la journ√©e: ${q3Avg}/3`
                ];
                
                questionStats.forEach(stat => {
                    pdf.text(stat, margin + 3, currentY);
                    currentY += 7;
                });
                
                // Nouvelle page pour les graphiques
                pdf.addPage();
                currentY = margin + 20;
                
                // Capture des graphiques avec am√©lioration de la qualit√©
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(76, 175, 80);
                pdf.text('üìä Graphiques d√©taill√©s', margin, currentY);
                currentY += 20;
                
                try {
                    // Fonction pour am√©liorer la qualit√© des graphiques
                    function enhanceCanvasForPDF(canvas) {
                        // Cr√©er un nouveau canvas avec une r√©solution plus √©lev√©e
                        const tempCanvas = document.createElement('canvas');
                        const tempCtx = tempCanvas.getContext('2d');
                        
                        // Doubler la r√©solution
                        tempCanvas.width = canvas.width * 2;
                        tempCanvas.height = canvas.height * 2;
                        
                        // Am√©liorer la qualit√©
                        tempCtx.imageSmoothingEnabled = true;
                        tempCtx.imageSmoothingQuality = 'high';
                        
                        // Dessiner le canvas original avec une meilleure qualit√©
                        tempCtx.scale(2, 2);
                        tempCtx.drawImage(canvas, 0, 0);
                        
                        return tempCanvas.toDataURL('image/png', 1.0);
                    }
                    
                    // Capturer le graphique d'√©volution avec titre
                    const timelineCanvas = document.getElementById('mood-timeline-chart');
                    if (timelineCanvas && charts.timeline) {
                        pdf.setFontSize(14);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(0, 0, 0);
                        pdf.text('√âvolution de votre humeur dans le temps', margin, currentY);
                        currentY += 15;
                        
                        const timelineImage = enhanceCanvasForPDF(timelineCanvas);
                        pdf.addImage(timelineImage, 'PNG', margin, currentY, contentWidth, 85);
                        currentY += 100;
                    }
                    
                    // V√©rifier si on a besoin d'une nouvelle page
                    if (currentY > pageHeight - 120) {
                        pdf.addPage();
                        currentY = margin + 20;
                    }
                    
                    // Capturer le graphique de distribution
                    const distributionCanvas = document.getElementById('emoji-distribution-chart');
                    if (distributionCanvas && charts.distribution) {
                        pdf.setFontSize(14);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(0, 0, 0);
                        pdf.text('Distribution des √©motions', margin, currentY);
                        currentY += 15;
                        
                        const distributionImage = enhanceCanvasForPDF(distributionCanvas);
                        const chartWidth = contentWidth * 0.75;
                        const chartHeight = 75;
                        const xOffset = (contentWidth - chartWidth) / 2;
                        
                        pdf.addImage(distributionImage, 'PNG', margin + xOffset, currentY, chartWidth, chartHeight);
                        currentY += 90;
                    }
                    
                    // V√©rifier si on a besoin d'une nouvelle page
                    if (currentY > pageHeight - 120) {
                        pdf.addPage();
                        currentY = margin + 20;
                    }
                    
                    // Capturer le graphique des questions
                    const questionsCanvas = document.getElementById('questions-avg-chart');
                    if (questionsCanvas && charts.questions) {
                        pdf.setFontSize(14);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(0, 0, 0);
                        pdf.text('Moyennes des r√©ponses aux questions', margin, currentY);
                        currentY += 15;
                        
                        const questionsImage = enhanceCanvasForPDF(questionsCanvas);
                        const chartWidth = contentWidth * 0.75;
                        const chartHeight = 75;
                        const xOffset = (contentWidth - chartWidth) / 2;
                        
                        pdf.addImage(questionsImage, 'PNG', margin + xOffset, currentY, chartWidth, chartHeight);
                        currentY += 90;
                    }
                    
                    // Capturer le graphique du cycle menstruel si applicable
                    const cycleCanvas = document.getElementById('cycle-correlation-chart');
                    if (cycleCanvas && charts.cycle && userGender === 'F') {
                        // V√©rifier si on a besoin d'une nouvelle page
                        if (currentY > pageHeight - 120) {
                            pdf.addPage();
                            currentY = margin + 20;
                        }
                        
                        pdf.setFontSize(14);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(255, 105, 180);
                        pdf.text('Corr√©lation avec le cycle menstruel', margin, currentY);
                        currentY += 15;
                        
                        const cycleImage = enhanceCanvasForPDF(cycleCanvas);
                        pdf.addImage(cycleImage, 'PNG', margin, currentY, contentWidth, 85);
                    }
                    
                } catch (error) {
                    console.error('Erreur lors de la capture des graphiques:', error);
                    pdf.setFontSize(12);
                    pdf.setTextColor(255, 0, 0);
                    pdf.text('‚ùå Erreur lors de la g√©n√©ration des graphiques', margin, currentY);
                }
                
                // Ajouter une page de conclusion
                pdf.addPage();
                currentY = margin + 30;
                
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(76, 175, 80);
                pdf.text('üí° Conclusion et conseils', margin, currentY);
                currentY += 20;
                
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(0, 0, 0);
                
                const conclusions = [
                    'Ce rapport vous donne un aper√ßu d√©taill√© de votre humeur sur la p√©riode s√©lectionn√©e.',
                    '',
                    'Conseils pour am√©liorer votre bien-√™tre :',
                    '‚Ä¢ Continuez √† enregistrer votre humeur quotidiennement',
                    '‚Ä¢ Identifiez les patterns dans vos √©motions',
                    '‚Ä¢ Consultez nos suggestions personnalis√©es',
                    '‚Ä¢ N\'h√©sitez pas √† consulter un professionnel si n√©cessaire',
                    '',
                    'L\'application MOODY vous accompagne dans votre bien-√™tre √©motionnel.',
                    'Prenez soin de vous ! üíö'
                ];
                
                conclusions.forEach(line => {
                    if (line === '') {
                        currentY += 5;
                    } else {
                        const lines = pdf.splitTextToSize(line, contentWidth);
                        pdf.text(lines, margin, currentY);
                        currentY += lines.length * 6;
                    }
                });
                
            } else {
                pdf.setFontSize(14);
                pdf.setTextColor(255, 140, 0);
                pdf.text('‚ö†Ô∏è Aucune donn√©e disponible pour la p√©riode s√©lectionn√©e.', margin, currentY);
                currentY += 20;
                pdf.setFontSize(12);
                pdf.setTextColor(0, 0, 0);
                pdf.text('Commencez √† enregistrer votre humeur pour voir appara√Ætre des analyses d√©taill√©es.', margin, currentY);
            }
            
            // T√©l√©charger le PDF
            const filename = `moody_analyse_${today.replace(/\//g, '-')}.pdf`;
            pdf.save(filename);
            
            showNotification('Rapport PDF t√©l√©charg√© avec succ√®s!');
        }
        
        function updateCharts() {
            fetchMoodData();
        }
        
        async function logout() {
            try {
                const response = await fetch('/api/logout', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    window.location.href = data.redirect || '/';
                }
            } catch (error) {
                console.error('Erreur lors de la d√©connexion:', error);
                window.location.href = '/';
            }
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            fetchMoodData();
        });
    </script>
</body>
</html>
